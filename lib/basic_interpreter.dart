import 'dart:collection';
import "statements.dart";
import "lexer.dart";
import "parser.dart";
import "context.dart";

/// Interpreter for a simple BASIC-like programming language.
///
/// This interpreter parses and executes a list of statements, managing [context]
/// and program flow.
class Interpreter {
  /// A sorted map where keys are line numbers and values are the corresponding statements.
  SplayTreeMap<int, Statement> programLines = SplayTreeMap();

  /// A map storing the current values of variables.
  final Context context = Context();

  /// Interprets the given program code.
  ///
  /// Parses the code into a list of statements and then executes them line by line, according to the line numbers specified in the code.
  ///
  /// Returns a list of strings, where each string is the output generated by PRINT statements.
  /// Throws an [Exception] if the parser does not find any statements.
  List<String> interpret(String code) {
    final lexer = Lexer(code);
    final parser = Parser(lexer.tokenize());

    programLines = parser.parse();
    List<String> outputLines = [];

    int? firstLine = programLines.firstKey();
    if (firstLine == null) {
      throw Exception("Parser did not find any statements!");
    }

    int currentLine = firstLine;
    while (currentLine > 0) {
      Statement statement = programLines[currentLine]!;
      print("$currentLine: $statement");

      if (statement is GotoStatement) {
        currentLine = statement.execute(context);
        continue;
      }

      if (statement is IfStatement) {
        int? jumpLine = statement.execute(context);
        if (jumpLine != null) {
          currentLine = jumpLine;
        }
        continue;
      }

      if (statement is EndStatement) {
        break;
      }

      // These statements increment line number in a normal way
      if (statement is PrintStatement) {
        String output = statement.execute(context);
        outputLines.add(output);
      } else if (statement is LetStatement) {
        statement.execute(context);
      } else if (statement is RemarkStatement) {
        // Do nothing
      } else {
        throw Exception("Unsupported statement type: $statement");
      }

      currentLine = programLines.keys.firstWhere(
        (lineNumber) => lineNumber > currentLine,
        orElse: () => -1,
      );
    }

    return outputLines;
  }
}
